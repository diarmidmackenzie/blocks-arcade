<!-- TetrisLand.  A VR world with many different Tetris Game Modes
     ... and perhaps some other things too...? -->

<html>
  <head>
    <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@2.0.0/dist/aframe-environment-component.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@4.2.1/dist/aframe-event-set-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmidmackenzie/key-bindings@latest/key-bindings.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmidmackenzie/6dof-object-control@v0.1-alpha/src/6dof-object-control.min.js"></script>
    <!--<script src="https://cdn.jsdelivr.net/gh/diarmidmackenzie/6dof-object-control@latest/src/keyboard-hand-controls.min.js"></script>-->
    <script src="../../6dof-object-control/src/keyboard-hand-controls.js"</script>
    <script src="keyboard-hand-controls.js"</script>
    <!-- couple of possible locations for tetris.js, depending on environment-->
    <script src="../../tetris-engine/src/tetris.js"></script>
    <script src="tetris.js"></script>
    <script>
    // Simple proximity detector.
    AFRAME.registerComponent('proximity', {
      schema: {
        target: {type: 'string', default: "#rhand"},
        distance: {type: 'number', default: 0.1},
        event: {type: 'string', default: "detected"},
        maxrate: {type: 'number', default: 1000}
      },

      init: function() {
        this.worldPosition = new THREE.Vector3();
      },

      update: function () {
        this.target = document.querySelector(this.data.target);
        this.lastEmitted = 0;
      },

      tick: function (time, timeDelta) {
        this.target.object3D.getWorldPosition(this.worldPosition);
        var distance = this.el.object3D.position.distanceTo(this.worldPosition);
        if (distance < this.data.distance) {
          if (time - this.lastEmitted > this.data.maxrate) {
            this.el.emit(this.data.event)
            this.lastEmitted = time;
          }
        }
      }
    });
   </script>
  </head>
  <body>
    <a-scene renderer="colorManagement:true">
      <a-entity id="rig" movement-controls>
        <a-entity camera position="0 1.6 0" look-controls>
        </a-entity>
        <a-entity id="rhand"
                  hand-controls="hand: right">
        </a-entity>
        <!-- Alternaive, for debugging on PC...
        <a-entity id="rhand"
                  hand-controls="hand: right"
                  keyboard-hand-controls="logger:#log-panel3"
                  position = "-3 1 -3">
        </a-entity>
        <a-text id="log-panel3" value="Keyboard Sim Data" position="-2 2 -4" color="black"></a-text>
        -->
        <a-entity id="lhand"
                  hand-controls="hand: left">
        </a-entity>
      </a-entity>
      <!-- for keyboard mode, put the controller behind the camera!
           in VR, it will auto-update to the true position) -->

      <a-mixin id="cube" geometry="primitive: box;"
               scale="0.1 0.1 0.1"
               shadow></a-mixin>
      <a-mixin id="metal" material="color:0xFFF;metalness:0.8"></a-mixin>
      <a-mixin id="glass" material="transparent:true;opacity:0.3"></a-mixin>

      <a-mixin id="start"
               src="start.png"
               scale="0.1 0.1 0.1"
               proximity="target:#rhand;event:start"
               event-set__start="_event: start; visible: false"
               event-set__gameover="_event: game-over; visible: true">
             </a-mixin>

      <a-entity environment="preset: forest; dressingAmount: 500"></a-entity>

<!--1: 2D TETRIS, 1st unit on the right ------------------------------------------>
      <!-- Note shapes have to be oriented N-S, not E-W due to the game orientation-->
      <a-entity id='shape-gen1' shapegenerator="arena:#arena1;shapes:NNN,NNU,NND,NUN,NDN,NUDN,NUS"
                                              position = "3 2 -3"></a-entity>
      <!-- game start control is a sphere, 10cm radius-->
      <a-sphere tetrisgame="generator: #shape-gen1; scoreboard: #scoreboard1; arena: #arena1"
                position="3 1 -2"
                mixin="glass start"
                src="start.png"
                rotation="0 -90 0"></a-sphere>

      <!-- Put the game on a metal stand-->
      <a-box shadow="receive:true" mixin="metal" height="0.5" width="0.5" depth="1.0" position = "3 0.25 -3.05" ></a-box>
      <a-plane mixin="metal" id="arena1" shadow="receive:true" height="1.0" width="0.1" rotation="-90 0 0" arena="x: 1; z: 10" position = "3 0.5 -3.05" ></a-plane>
      <a-box mixin="glass" height="1.5" width="0.5" depth="1.0" position = "3 1.25 -3.05" ></a-box>

      <!--Scoreboard, and some text to guide the user-->
      <a-text id="scoreboard1" value="Score" rotation="0 -90 0" position="3 1.8 -2.3" color="black"></a-text>
      <a-text value="Classic\n2D Tetris" rotation="0 -90 0" position="2.75 0.25 -3.5" color="black"></a-text>

<!--2: 3D TETRIS, 1st unit on the left ---------------------------------------->
      <!-- Note shapes have to be oriented N-S, not E-W due to the game orientation-->
      <a-entity id='shape-gen2' shapegenerator="arena:#arena2" position = "-3 2 -3"></a-entity>
      <!-- game start control is a sphere, 10cm radius, to the right of the game-->
      <a-sphere tetrisgame="generator: #shape-gen2; scoreboard: #scoreboard2; arena: #arena2"
                position="-3 1 -3.75"
                mixin="glass start"
                src="start.png"
                rotation="0 90 0"></a-sphere>

      <!-- Put the game on a metal stand-->
      <a-box shadow="receive:true" mixin="metal" height="0.5" width="0.7" depth="0.7" position = "-3 0.25 -3" ></a-box>
      <a-plane mixin="metal" id="arena2" shadow="receive:true" height="0.5" width="0.5" rotation="-90 0 0"  arena="x: 5; z: 5" position = "-3 0.5 -3" ></a-plane>
      <a-box mixin="glass" height="1.5" width="0.5" depth="0.5" position = "-3 1.25 -3" ></a-box>

      <!--Scoreboard, and some text to guide the user-->
      <a-text id="scoreboard2" value="Score" rotation="0 90 0" position="-3 1.8 -3.3" color="black"></a-text>
      <a-text value="3D\nTetris" rotation="0 90 0" position="-2.65 0.25 -2.65" color="black"></a-text>


      <!--Overhead lighting is important for 3D Tetris -->
      <a-entity light="type:directional; castShadow:true;" position='3 20 -3'></a-entity>

<!--3: 2D PENTRIS, 2nd unit on the right -------------------------------------->
      <!-- Note shapes have to be oriented N-S, not E-W due to the game orientation-->
      <a-entity id='shape-gen3' shapegenerator="arena:#arena3;
                                              shapes:shapes:NNNN,NNNU,NNND,NNUN,NNDN,NNDD,NNDS,NNUS,NNSDD,NDND,NDNSD,SDSND,NUDDUN"
                                              position = "3 2 -6"></a-entity>
      <!-- game start control is a sphere, 10cm radius-->
      <a-sphere tetrisgame="generator: #shape-gen3; scoreboard: #scoreboard3; arena: #arena3"
                position="3 1 -5"
                mixin="glass start"
                src="start.png"
                rotation="0 -90 0"></a-sphere>

      <!-- Put the game on a metal stand-->
      <a-box shadow="receive:true" mixin="metal" height="0.5" width="0.5" depth="1.2" position = "3 0.25 -6.05" ></a-box>
      <a-plane mixin="metal" id="arena3" shadow="receive:true" height="1.2" width="0.1" rotation="-90 0 0"  arena="x: 1; z: 12" position = "3 0.5 -6.05" ></a-plane>
      <a-box mixin="glass" height="1.5" width="0.5" depth="1.2" position = "3 1.25 -6.05" ></a-box>

      <!--Scoreboard, and some text to guide the user-->
      <a-text id="scoreboard3" value="Score" rotation="0 -90 0" position="3 1.8 -5.3" color="black"></a-text>
      <a-text value="2D Pentris" rotation="0 -90 0" position="2.75 0.25 -6.5" color="black"></a-text>

<!--3D PENTRIS, 2nd unit on the left ------------------------------------------>
      <!-- For now, we just use the 2D pentris tiles, re-oriented to the X/Z plane-->
      <!-- TBC whether this makes for a fun game... -->

      <a-entity id='shape-gen4'
                shapegenerator="arena:#arena4;shapes:shapes:NNNN,NNNE,NNNW,NNEN,NNWN,NNWW,NNWS,NNES,NNSWW,NWNW,NWNSW,SWSNW,NEWWEN"
                position = "-3 2 -6"></a-entity>
      <!-- game start control is a sphere, 10cm radius, to the right of the game-->
      <a-sphere tetrisgame="generator: #shape-gen4; scoreboard: #scoreboard4; arena: #arena4"
                position="-3 1 -6.75"
                mixin="glass start"
                src="start.png"
                rotation="0 90 0"></a-sphere>

      <!-- Put the game on a metal stand-->
      <a-box shadow="receive:true" mixin="metal" height="0.5" width="0.7" depth="0.7" position = "-3.05 0.25 -6.05" ></a-box>
      <a-plane mixin="metal" id="arena4" shadow="receive:true" height="0.6" width="0.6" rotation="-90 0 0" arena="x: 6; z: 6" position = "-3.05 0.5 -6.05" ></a-plane>
      <a-box mixin="glass" height="1.5" width="0.6" depth="0.6" position = "-3.05 1.25 -6.05" ></a-box>

      <!--Scoreboard, and some text to guide the user-->
      <a-text id="scoreboard4" value="Score" rotation="0 90 0" position="-3.05 1.8 -6.45" color="black"></a-text>
      <a-text value="3D\nPentris" rotation="0 90 0" position="-2.7 0.25 -5.7" color="black"></a-text>

      <!--Overhead lighting is important for 3D Tetris games
          This one will probably wreck the nearby 3D Tetris, though...
          So leave it off.  Ideally we need to be able to turn lights on/off when
          game starts-->

      <!--<a-entity light="type:directional; castShadow:true;" position='3 20 -6'></a-entity>-->

    </a-scene>
  </body>
</html>
